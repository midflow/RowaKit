/**
 * Demo 08: Advanced Patterns
 * Shows combining filters, URL sync, saved views, and proper error handling
 */

import { RowaKitTable, col } from '@rowakit/table';
import type { Fetcher, FetcherQuery } from '@rowakit/table';
import { useState, useEffect } from 'react';

interface Order {
  id: string;
  customer: string;
  status: 'pending' | 'shipped' | 'delivered';
  amount: number;
  date: string;
}

const MOCK_ORDERS: Order[] = [
  { id: '1', customer: 'Acme Inc', status: 'delivered', amount: 5000, date: '2024-02-01' },
  { id: '2', customer: 'TechCorp', status: 'shipped', amount: 8000, date: '2024-02-05' },
  { id: '3', customer: 'GlobalTrade', status: 'pending', amount: 12000, date: '2024-02-10' },
  { id: '4', customer: 'StartupXYZ', status: 'delivered', amount: 3000, date: '2024-02-12' },
  { id: '5', customer: 'Enterprise Ltd', status: 'pending', amount: 25000, date: '2024-02-15' },
];

const fetcher: Fetcher<Order> = async (query) => {
  await new Promise((r) => setTimeout(r, 400));

  // Simulate occasional errors (5% chance)
  if (Math.random() < 0.05) {
    throw new Error('Server error: Failed to fetch orders');
  }

  let data = [...MOCK_ORDERS];

  if (query.sort) {
    data.sort((a, b) => {
      const av = a[query.sort!.field as keyof Order];
      const bv = b[query.sort!.field as keyof Order];
      const cmp = av < bv ? -1 : av > bv ? 1 : 0;
      return query.sort!.direction === 'asc' ? cmp : -cmp;
    });
  }

  const start = (query.page - 1) * query.pageSize;
  return {
    items: data.slice(start, start + query.pageSize),
    total: data.length,
  };
};

const STORAGE_KEY = 'demo-advanced-views';

export default function AdvancedQueryDemo() {
  const [query, setQuery] = useState<FetcherQuery>({ page: 1, pageSize: 5 });
  const [error, setError] = useState<string | null>(null);
  const [views, setViews] = useState<{ name: string; query: FetcherQuery }[]>(() => {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    } catch {
      return [];
    }
  });
  const [saveName, setSaveName] = useState('');

  // Sync to URL
  useEffect(() => {
    const params = new URLSearchParams();
    if (query.page !== 1) params.set('page', String(query.page));
    if (query.sort) {
      params.set('sortBy', query.sort.field);
      params.set('sortDir', query.sort.direction);
    }
    const url = params.toString() ? `?${params}` : '';
    window.history.replaceState(null, '', url || window.location.pathname);
  }, [query]);

  const saveView = () => {
    if (!saveName.trim()) return;
    const updated = [...views.filter((v) => v.name !== saveName), { name: saveName, query }];
    setViews(updated);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
    setSaveName('');
  };

  const loadView = (name: string) => {
    const view = views.find((v) => v.name === name);
    if (view) setQuery(view.query);
  };

  return (
    <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
      <div style={{ backgroundColor: '#f0f9ff', padding: '12px', borderRadius: '6px', fontSize: '13px' }}>
        <strong>Demo Notes:</strong> Advanced patterns:
        <ul style={{ margin: '8px 0', paddingLeft: '20px' }}>
          <li>URL sync: Sort, pagination â†’ URL params</li>
          <li>Saved views: Save current state to localStorage</li>
          <li>Error handling: Network errors show gracefully</li>
        </ul>
      </div>

      {error && (
        <div style={{ backgroundColor: '#fee', border: '1px solid #fcc', padding: '12px', borderRadius: '6px', color: '#c00', fontSize: '13px' }}>
          <strong>Error:</strong> {error}
          <button onClick={() => setError(null)} style={{ marginLeft: '8px', cursor: 'pointer' }}>
            Dismiss
          </button>
        </div>
      )}

      <div style={{ display: 'flex', gap: '8px', padding: '12px', backgroundColor: '#f5f5f5', borderRadius: '6px' }}>
        <input
          type="text"
          placeholder="Save view"
          value={saveName}
          onChange={(e) => setSaveName(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && saveView()}
          style={{ padding: '6px', borderRadius: '4px', border: '1px solid #ddd', flex: 1 }}
        />
        <button onClick={saveView} style={{ padding: '6px 12px', borderRadius: '4px', border: '1px solid #ddd' }}>
          Save
        </button>
      </div>

      {views.length > 0 && (
        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
          {views.map((v) => (
            <button
              key={v.name}
              onClick={() => loadView(v.name)}
              style={{ padding: '6px 12px', backgroundColor: '#e8f4f8', border: '1px solid #bbb', borderRadius: '4px', cursor: 'pointer' }}
            >
              {v.name}
            </button>
          ))}
        </div>
      )}

      <RowaKitTable
        fetcher={fetcher}
        columns={[
          col.text<Order>('customer', { sortable: true }),
          col.badge<Order>('status', {
            options: [
              { value: 'pending', label: 'Pending', color: 'yellow' },
              { value: 'shipped', label: 'Shipped', color: 'blue' },
              { value: 'delivered', label: 'Delivered', color: 'green' },
            ],
          }),
          col.number<Order>('amount', { align: 'right', format: (v) => `$${v.toLocaleString()}`, sortable: true }),
          col.text<Order>('date', { sortable: true }),
        ]}
        rowKey="id"
        defaultPageSize={5}
        key={JSON.stringify(query)}
      />
    </div>
  );
}
